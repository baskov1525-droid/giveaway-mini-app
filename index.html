<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–æ–∑—ã–≥—Ä—ã—à</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 20px;
        }
        h1, h2 { text-align: center; }
        .giveaway { border: 1px solid var(--tg-theme-hint-color); border-radius: 12px; padding: 16px; margin: 16px 0; }
        .photo { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; }
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin: 16px 0;
        }
        .ticket {
            aspect-ratio: 1;
            background: var(--tg-theme-secondary-bg-color);
            border: 2px solid transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ticket.taken { background: #4caf50; color: white; cursor: default; }
        .ticket.selected { border: 3px solid gold; background: #ffeb3b; color: black; }
        .ticket.free:hover { border: 2px solid var(--tg-theme-button-color); }
        #status { text-align: center; font-size: 18px; margin: 20px 0; min-height: 40px; }
        button { padding: 12px 24px; margin: 8px; font-size: 16px; border-radius: 12px; }
    </style>
</head>
<body>
    <h1>–†–æ–∑—ã–≥—Ä—ã—à–∏</h1>
    <div id="giveaways"></div>
    <div id="current-giveaway" style="display:none;">
        <h2 id="title"></h2>
        <img id="photo" class="photo" alt="–ü—Ä–∏–∑">
        <p id="desc"></p>
        <p>–¶–µ–Ω–∞ –Ω–æ–º–µ—Ä–∫–∞: <span id="price"></span> ‚ÇΩ</p>
        <p>–í—Å–µ–≥–æ –Ω–æ–º–µ—Ä–∫–æ–≤: <span id="total"></span></p>
        <div id="tickets-grid" class="tickets-grid"></div>
        <div id="status"></div>
        <button id="refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="draw" style="display:none; background:#f44336; color:white;">–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à</button>
        <button id="create-btn" style="display:none;">–°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à</button>
    </div>

    <script>
        const BACKEND = "https://subaxillary-grayson-leprously.ngrok-free.dev";
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();

        let currentGiveawayId = null;

        async function api(endpoint, method = "GET", body = null) {
            const initData = tg.initData;
            const headers = { "Content-Type": "application/json" };
            const res = await fetch(`${BACKEND}${endpoint}`, {
                method,
                headers,
                body: body ? JSON.stringify({ ...body, init_data: initData }) : null
            });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        async function loadGiveaways() {
            try {
                const data = await api("/api/giveaways");
                const container = document.getElementById("giveaways");
                container.innerHTML = "";
                data.forEach(g => {
                    const div = document.createElement("div");
                    div.className = "giveaway";
                    div.innerHTML = `
                        <h3>${g.title}</h3>
                        <p>${g.description}</p>
                        <img src="${g.photo_url}" style="width:100%; max-height:200px; object-fit:cover; border-radius:12px;">
                        <p>–ù–æ–º–µ—Ä–∫–æ–≤: ${g.ticket_count} √ó ${g.ticket_price} ‚ÇΩ</p>
                        <button onclick="openGiveaway(${g.id})">–û—Ç–∫—Ä—ã—Ç—å</button>
                    `;
                    container.appendChild(div);
                });
            } catch (e) {
                document.getElementById("status").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
            }
        }

        async function openGiveaway(id) {
            currentGiveawayId = id;
            document.getElementById("giveaways").style.display = "none";
            document.getElementById("current-giveaway").style.display = "block";

            const data = await api(`/api/giveaway/${id}/tickets`, "GET");
            document.getElementById("title").textContent = "–†–æ–∑—ã–≥—Ä—ã—à # " + id;
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å title, description, photo_url, price –∏–∑ API (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
            document.getElementById("total").textContent = "100"; // ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ
            document.getElementById("price").textContent = "100";

            const grid = document.getElementById("tickets-grid");
            grid.innerHTML = "";

            const taken = data.taken || {};
            for (let i = 1; i <= 100; i++) {
                const t = document.createElement("div");
                t.className = "ticket";
                t.textContent = i;
                if (taken[i]) {
                    t.classList.add("taken");
                    t.title = taken[i].username || taken[i].user_id;
                } else {
                    t.classList.add("free");
                    t.onclick = () => buyTicket(i);
                }
                grid.appendChild(t);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É
            const user = tg.initDataUnsafe.user;
            if (user && ADMIN_IDS.includes(user.id)) {
                document.getElementById("draw").style.display = "block";
                document.getElementById("create-btn").style.display = "block";
            }
        }

        async function buyTicket(number) {
            if (!confirm(`–ö—É–ø–∏—Ç—å –Ω–æ–º–µ—Ä–æ–∫ ${number}?`)) return;
            try {
                const res = await api(`/api/giveaway/${currentGiveawayId}/buy_ticket`, "POST", { ticket_number: number });
                openGiveaway(currentGiveawayId);
                document.getElementById("status").textContent = `–ù–æ–º–µ—Ä–æ–∫ ${number} –≤–∞—à!`;
            } catch (e) {
                document.getElementById("status").textContent = e.message;
            }
        }

        async function animateDraw() {
            const status = document.getElementById("status");
            status.innerHTML = "–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞... üé∞";

            const spins = 60;
            const delay = 80;

            for (let i = 0; i < spins; i++) {
                const num = Math.floor(Math.random() * 100) + 1;
                status.innerHTML = `–ù–æ–º–µ—Ä: <span style="font-size:48px; color:gold;">${num}</span>`;
                await new Promise(r => setTimeout(r, delay));
            }

            const result = await api(`/api/giveaway/${currentGiveawayId}/draw`, "POST");
            if (result.status === "success") {
                const w = result.winner;
                status.innerHTML = `<span style="font-size:32px; color:gold;">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${w.username ? '@' + w.username : w.name} (–Ω–æ–º–µ—Ä ${w.ticket})</span>`;
                confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
            } else {
                status.innerHTML = "–û—à–∏–±–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–∞";
            }
        }

        document.getElementById("draw").onclick = animateDraw;

        document.getElementById("refresh").onclick = () => openGiveaway(currentGiveawayId);

        document.getElementById("create-btn").onclick = async () => {
            const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞");
            const desc = prompt("–û–ø–∏—Å–∞–Ω–∏–µ");
            const photo = prompt("URL —Ñ–æ—Ç–æ –ø—Ä–∏–∑–∞");
            const count = prompt("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–º–µ—Ä–∫–æ–≤");
            const price = prompt("–¶–µ–Ω–∞ –∑–∞ 1 –Ω–æ–º–µ—Ä–æ–∫");

            if (!title || !desc || !photo || !count || !price) return;

            try {
                const res = await api("/api/create_giveaway", "POST", {
                    title, description: desc, photo_url: photo, ticket_count: count, ticket_price: price
                });
                alert("–†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω! ID: " + res.giveaway_id);
                loadGiveaways();
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e.message);
            }
        };

        // –ó–∞–ø—É—Å–∫
        loadGiveaways();
    </script>
</body>
</html>